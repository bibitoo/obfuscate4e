package de.partmaster.obfuscate4e.proguard.generator;

import de.partmaster.obfuscate4e.generator.IBuildGenerator;
import de.partmaster.obfuscate4e.generator.ProjectData;

public class ProguardCustomBuildScriptGenerator implements IBuildGenerator {

  protected static String nl;
  public static synchronized ProguardCustomBuildScriptGenerator create(String lineSeparator)
  {
    nl = lineSeparator;
    ProguardCustomBuildScriptGenerator result = new ProguardCustomBuildScriptGenerator();
    nl = null;
    return result;
  }

  public final String NL = nl == null ? (System.getProperties().getProperty("line.separator")) : nl;
  protected final String TEXT_1 = "<!-- ===================================================================== -->" + NL + "<!-- Custom targets called from a project's generated build.xml            -->" + NL + "<!-- Set customBuildCallbacks=<path/to/this/file> in your build.properties.-->" + NL + "<!-- ===================================================================== -->" + NL + "<!--" + NL + "   $Id:$" + NL + " -->" + NL + "<project name=\"Build specific targets and properties\" default=\"noDefault\">" + NL + "\t<property name=\"temp.o4e.folder\" value=\"${basedir}/temp.obfuscate4e\" />" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- target to postprocess the compiled artefacts - used for obfuscation   -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.@dot\">" + NL + "\t\t<property name=\"proguard.map\" value=\"${temp.o4e.folder}/proguard.map\" />" + NL + "\t\t<property name=\"obfuscated.jar\" value=\"${temp.o4e.folder}/obfuscated-classes.jar\" />" + NL + "\t\t<mkdir dir=\"${temp.o4e.folder}\"/>" + NL + "" + NL + "        <!--" + NL + "            we need to strip off non-existing files or directories in classpath," + NL + "            because proguard doesn't like them" + NL + "        -->" + NL + "        <path id=\"complete.dot.classpath\">" + NL + "        \t<fileset dir=\"${java.home}/lib/\">" + NL + "\t        \t<include name=\"**/rt.jar\"/>" + NL + "        \t</fileset>" + NL + "        \t<path refid=\"@dot.classpath\"/>" + NL + "        </path>" + NL + "        <pathconvert property=\"tmp.classpath\" refid=\"complete.dot.classpath\">" + NL + "\t\t\t<mapper classname=\"de.partmaster.obfuscate4e.ant.ExistsFileNameMapper\" />" + NL + "        </pathconvert>" + NL + "\t\t<path id=\"classpath.libs\">" + NL + "\t\t\t<pathelement path=\"${tmp.classpath}\" />" + NL + "\t\t</path>" + NL + "" + NL + "        <!-- now do the obfuscation -->" + NL + "\t\t<proguard configuration=\"${basedir}/proguard.cfg\">" + NL + "\t\t\t<injar dir=\"${jar.Location}\" />" + NL + "\t\t\t<outjar file=\"${obfuscated.jar}\" />" + NL + "\t\t\t<libraryjar refid=\"classpath.libs\" />" + NL + "\t\t</proguard>" + NL + "" + NL + "\t\t<!--" + NL + "\t\t\tremove original (unobfuscated) classes from build location," + NL + "\t\t\textract obfuscated content into build location and " + NL + "\t\t\tdelete all temporary content" + NL + "\t\t-->" + NL + "\t\t<delete includeemptydirs=\"true\">" + NL + "            <fileset dir=\"${jar.Location}\" includes=\"**/*\" />" + NL + "        </delete>" + NL + "\t\t<unjar src=\"${obfuscated.jar}\" dest=\"${jar.Location}\" >" + NL + "\t\t\t<patternset excludes=\"META-INF/MANIFEST.MF\" />" + NL + "\t\t</unjar>" + NL + "\t\t<delete file=\"${obfuscated.jar}\"/>" + NL + "\t</target>" + NL + "\t" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Default target                                                        -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"noDefault\">" + NL + "\t\t<echo message=\"This file must be called with explicit targets\" />" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do before the target build.jars                              -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   build.result.folder - folder to contain the build results           -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"pre.build.jars\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do after the target build.jars                               -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   build.result.folder - folder to contain the build results           -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.build.jars\">" + NL + "\t</target>" + NL + "\t" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do before the target build.sources                           -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   build.result.folder - folder to contain the build results           -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"pre.build.sources\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do after the target build.sources                            -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   build.result.folder - folder to contain the build results           -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.build.sources\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do before the compilation target <name>                      -->" + NL + "\t<!-- Substitute \"name\" with the name of the compilation target, eg @dot    -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   source.foldern : n = 1 ... N, the source folders                    -->" + NL + "\t<!--   target.folder  : where the results of the compilation go            -->" + NL + "\t<!--   <name>.classpath : name = name of the compilation target. A         -->" + NL + "\t<!--                      reference to the classpath structure.            -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"pre.name\">" + NL + "\t</target>" + NL + "" + NL + "\t<target name=\"pre.@dot\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do during the compilation target <name>, after the compile   -->" + NL + "\t<!-- but before jaring.  Substitute \"name\" with the name of the compilation-->" + NL + "\t<!-- target, eg @dot                                                       -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   source.foldern : n = 1 ... N, the source folders                    -->" + NL + "\t<!--   target.folder  : where the results of the compilation go            -->" + NL + "\t<!--   <name>.classpath : name = name of the compilation target. A         -->" + NL + "\t<!--                      reference to the classpath structure.            -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.compile.name\">" + NL + "\t</target>" + NL + "" + NL + "\t<target name=\"post.compile.@dot\">" + NL + "\t</target>" + NL + "\t" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do after the compilation target <name>                       -->" + NL + "\t<!-- Substitute \"name\" with the name of the compilation target, eg @dot    -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   jar.location - the location of the compilation results              -->" + NL + "\t<!--   <name>.classpath : name = name of the compilation target. A         -->" + NL + "\t<!--                      reference to the classpath structure.            -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.name\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do before the target gather.bin.parts                         -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   build.result.folder - folder containing the build results           -->" + NL + "\t<!--   target.folder - destination folder                                  -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"pre.gather.bin.parts\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do after the target gather.bin.parts                         -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   build.result.folder - folder containing the build results           -->" + NL + "\t<!--   target.folder - destination folder                                  -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.gather.bin.parts\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do before the target gather.sources                          -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   destination.temp.folder - destination folder                        -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"pre.gather.sources\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do after the target gather.sources                           -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   destination.temp.folder - destination folder                        -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.gather.sources\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do before the target gather.logs                             -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   destination.temp.folder - destination folder                        -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"pre.gather.logs\">" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do after the target gather.logs                              -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   destination.temp.folder - destination folder                        -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.gather.logs\">" + NL + "\t\t<delete dir=\"${temp.o4e.folder}\"/>" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do before the target clean                                   -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   destination.temp.folder - destination folder                        -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"pre.clean\">" + NL + "\t\t<copy todir=\"${destination.temp.folder}\" failonerror=\"false\" overwrite=\"false\">" + NL + "\t\t\t<fileset dir=\"${temp.o4e.folder}\">" + NL + "\t\t\t\t<include name=\"*\"/>" + NL + "\t\t\t</fileset>" + NL + "\t\t</copy>" + NL + "\t\t<delete dir=\"${temp.o4e.folder}\"/>" + NL + "\t</target>" + NL + "" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<!-- Steps to do after the target clean                                    -->" + NL + "\t<!-- Available parameters :                                                -->" + NL + "\t<!--   plugin.destination - final destination of the build                 -->" + NL + "\t<!--   build.result.folder - results of the compilation                    -->" + NL + "\t<!--   temp.folder - temporary folder                                      -->" + NL + "\t<!-- ===================================================================== -->" + NL + "\t<target name=\"post.clean\">" + NL + "\t</target>" + NL + "</project>";

	public String generate(ProjectData argument)
  {
    final StringBuffer stringBuffer = new StringBuffer();
    stringBuffer.append(TEXT_1);
    return stringBuffer.toString();
  }
}